<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Image Basics Lab ‚Äî Core Properties Dashboard</title>
<style>
:root{
  --bg:#0b0d12;--panel:#121621;--muted:#8b93a7;--text:#e9edf5;
  --accent:#7aa2ff;--accent-2:#ff4d4d;--success:#4caf50;
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,#0b0d12,#0e1320);color:var(--text);
  font:15px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
  display:flex;flex-direction:column;align-items:center;min-height:100vh}
header{display:flex;gap:16px;align-items:center;justify-content:space-between;
  padding:16px 20px;border-bottom:1px solid #1d2333;background:rgba(10,14,25,.7);
  backdrop-filter:saturate(140%) blur(6px);position:sticky;top:0;z-index:10;width:100%;max-width:1400px}
h1{font-size:20px;margin:0;font-weight:700}
.badge{background:#1a2545;border:1px solid #2b3552;border-radius:999px;font-size:12px;padding:6px 10px}
.badge.success{background:#1a3d1a;border-color:#2d5a2d;color:#90ee90}
.container{max-width:1400px;margin:18px auto;padding:0 16px;width:100%}
.row{display:grid;grid-template-columns:380px 1fr;gap:18px}
@media (max-width: 920px){.row{grid-template-columns:1fr}}
.panel{background:var(--panel);border:1px solid #242a3b;border-radius:14px;padding:14px 16px;box-shadow:0 8px 26px rgba(0,0,0,.25)}
.panel h2{margin:0 0 8px;font-size:16px;color:#bfc7dc}
.sub{font-size:12px;color:var(--muted);margin:2px 0 10px}
.controls{display:grid;gap:12px}
.control{display:grid;gap:6px}
label{font-size:12px;color:#b7bfd6;font-weight:600}
select,input[type="file"],button{
  width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a3046;background:#0f1424;color:var(--text)}
.range{display:flex;gap:10px;align-items:center}
.range input[type="range"]{flex:1;cursor:pointer}
.range .val{min-width:70px;text-align:right;font-weight:600;color:#cfe1ff}
.toggles{display:flex;gap:8px;flex-wrap:wrap}
.toggles label{display:flex;gap:6px;align-items:center;background:#0f1424;border:1px solid #2a3046;border-radius:999px;padding:7px 10px;font-size:12px}
.toggles input{accent-color:#6f92ff}
.button-row{display:flex;gap:8px;flex-wrap:wrap}
button{cursor:pointer;background:linear-gradient(180deg,#1b2140,#121933);border:1px solid #2b3352}
button.primary{background:linear-gradient(180deg,#3552ff,#1a2cd1);border-color:#5b72ff}
button.secondary{background:#14203a}
.stage{display:flex;gap:20px;align-items:flex-start;justify-content:center;flex-wrap:wrap}
.canvas-wrap{position:relative;border-radius:14px;overflow:hidden;background:#0a0f1f;border:1px solid #242a3b;box-shadow:0 4px 20px rgba(0,0,0,.25)}
.canvas-wrap header{position:absolute;inset:auto auto 10px 10px;background:rgba(13,18,35,.9);border:1px solid #263055;border-radius:8px;padding:6px 10px;font-size:13px;font-weight:700}
canvas{display:block;width:320px;height:320px;image-rendering:crisp-edges}
.stats{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.stat{background:#0e1528;border:1px solid #263055;border-radius:999px;padding:6px 10px;font-size:12px}
.histobox{background:#0e1426;border:1px solid #263055;border-radius:10px;padding:10px}
.histocanvas{width:320px;height:80px;display:block}
.footer{margin:30px auto;color:var(--muted);font-size:13px;text-align:center;max-width:700px}
.small{font-size:12px;color:#9fb0d6}
#formulasDisplay{
  background:#0a0c15;
  border:1px solid #1a1f30;
  border-radius:8px;
  padding:12px;
  max-height:300px;
  overflow-y:auto;
  scrollbar-width:thin;
  scrollbar-color:#2a3046 #0a0c15;
}
#formulasDisplay::-webkit-scrollbar{width:6px}
#formulasDisplay::-webkit-scrollbar-track{background:#0a0c15}
#formulasDisplay::-webkit-scrollbar-thumb{background:#2a3046;border-radius:3px}
</style>
</head>
<body>
<header>
  <h1>üñºÔ∏è Image Basics Lab ‚Äî Core Properties</h1>
  <div class="badge success">Real-time processing</div>
</header>

<main class="container">
  <section class="row">
    <div class="panel">
      <h2>Step 1 ‚Äî Load an image</h2>
      <p class="sub">Use a sample or upload your own. Processing runs locally in your browser.</p>
      <div class="controls">
        <div class="control">
          <label for="imgPick">Sample Images</label>
          <select id="imgPick">
            <option value="dogs">Dog Breeds (color)</option>
            <option value="portrait">Portrait</option>
            <option value="city">Cityscape</option>
            <option value="gradient">Gradient</option>
            <option value="checker">Checkerboard</option>
          </select>
        </div>
        <div class="control">
          <label for="file">Upload</label>
          <input id="file" type="file" accept="image/*"/>
        </div>
      </div>

      <h2 style="margin-top:12px">Step 2 ‚Äî Adjust properties</h2>
      <div class="controls" id="sliders">
        <div class="control">
          <label>Brightness (‚àí100‚Ä¶+100)</label>
          <div class="range"><input id="sBright" type="range" min="-100" max="100" value="0"/><span class="val" id="vBright">0</span></div>
        </div>
        <div class="control">
          <label>Contrast (0‚Ä¶300%)</label>
          <div class="range"><input id="sContrast" type="range" min="0" max="300" value="100"/><span class="val" id="vContrast">100%</span></div>
        </div>
        <div class="control">
          <label>Exposure (factor 0.1‚Ä¶3.0)</label>
          <div class="range"><input id="sExposure" type="range" min="10" max="300" value="100"/><span class="val" id="vExposure">1.00√ó</span></div>
        </div>
        <div class="control">
          <label>Gamma (0.20‚Ä¶3.00)</label>
          <div class="range"><input id="sGamma" type="range" min="20" max="300" value="100"/><span class="val" id="vGamma">1.00</span></div>
        </div>
        <div class="control">
          <label>Saturation (0‚Ä¶300%)</label>
          <div class="range"><input id="sSat" type="range" min="0" max="300" value="100"/><span class="val" id="vSat">100%</span></div>
        </div>
        <div class="control">
          <label>Hue (‚àí180‚Ä¶+180¬∞)</label>
          <div class="range"><input id="sHue" type="range" min="-180" max="180" value="0"/><span class="val" id="vHue">0¬∞</span></div>
        </div>
        <div class="control">
          <label>Blur Radius (0‚Ä¶5 px)</label>
          <div class="range"><input id="sBlur" type="range" min="0" max="5" value="0"/><span class="val" id="vBlur">0</span></div>
        </div>
        <div class="control">
          <label>Sharpness / Unsharp Amount (0‚Ä¶2.0)</label>
          <div class="range"><input id="sSharp" type="range" min="0" max="200" value="0"/><span class="val" id="vSharp">0.00</span></div>
        </div>
        <div class="control">
          <label>Bit Depth (1‚Ä¶8 bits/channel)</label>
          <div class="range"><input id="sBits" type="range" min="1" max="8" value="8"/><span class="val" id="vBits">8-bit</span></div>
        </div>
        <div class="toggles">
          <label><input id="tGray" type="checkbox"/> Grayscale</label>
          <label><input id="tInvert" type="checkbox"/> Invert</label>
        </div>
        <div class="button-row">
          <button class="secondary" id="btnReset">Reset All</button>
          <button class="primary" id="btnRandom">Randomize</button>
        </div>
      </div>
      <p class="small">Order of operations: Hue/Sat ‚Üí Exposure ‚Üí Brightness/Contrast ‚Üí Gamma ‚Üí Blur ‚Üí Unsharp ‚Üí Bit Depth ‚Üí Grayscale/Invert.</p>
    </div>

    <div class="panel">
      <h2>Step 3 ‚Äî Preview & histogram</h2>
      <p class="sub">Before/After at 256√ó256 for speed. Drag a new image on the page to load it.</p>
      
      <div class="panel" style="background:#0a0f1f;border:1px solid #1a2035;margin-bottom:12px">
        <h3 style="font-size:14px;margin:0 0 8px;color:#7aa2ff">Active Formulas & Equations</h3>
        <div id="formulasDisplay" style="font-family:monospace;font-size:12px;line-height:1.8;color:#cfe1ff"></div>
      </div>
      
      <div class="stage">
        <div class="canvas-wrap">
          <header>Input</header>
          <canvas id="inCanvas" width="256" height="256"></canvas>
        </div>
        <div class="canvas-wrap">
          <header>Output</header>
          <canvas id="outCanvas" width="256" height="256"></canvas>
        </div>
      </div>
      <div class="stats">
        <span class="stat">Mean: <span id="stMean">--</span></span>
        <span class="stat">StdDev: <span id="stStd">--</span></span>
        <span class="stat">Min..Max: <span id="stMinMax">--</span></span>
      </div>
      <div class="histobox" style="margin-top:10px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <div style="font-weight:700;color:#bfc7dc">Output Luma Histogram</div>
          <div class="small" id="histNote">0‚Ä¶255</div>
        </div>
        <canvas id="histCanvas" width="320" height="80" class="histocanvas"></canvas>
      </div>
    </div>
  </section>

  <p class="footer">
    Tip: Try <em>extreme</em> settings (e.g., Saturation 0%, Gamma 0.3, Bit Depth 2) to see classic artifacts like posterization and wash-out.
  </p>
</main>

<script>
// ---------- Utilities ----------
const $ = s => document.querySelector(s);
const clamp = (v,lo=0,hi=255)=>Math.max(lo,Math.min(hi,v));
const lerp = (a,b,t)=>a+(b-a)*t;

// Sample images
const IMG_URLS = {
  dogs: "https://upload.wikimedia.org/wikipedia/commons/1/18/Dog_Breeds.jpg",
  portrait: "https://upload.wikimedia.org/wikipedia/commons/thumb/2/2a/Human_faces.jpg/1200px-Human_faces.jpg",
  city: "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5f/Manhattan3_amk.jpg/1280px-Manhattan3_amk.jpg"
};

// Canvas + contexts
const inC = $("#inCanvas"), outC = $("#outCanvas");
const inX = inC.getContext("2d"), outX = outC.getContext("2d");
const histC = $("#histCanvas"), histX = histC.getContext("2d");

// State
let sourceImage = new Image(); sourceImage.crossOrigin="anonymous";
let srcImageData = null; // original RGBA @ 256x256

// ---------- Loaders ----------
function drawCover(img, ctx, size=256){
  const s = size;
  ctx.clearRect(0,0,s,s);
  const scale = Math.max(s/img.width, s/img.height);
  const w = img.width*scale, h = img.height*scale;
  const dx = (s-w)/2, dy = (s-h)/2;
  ctx.drawImage(img, dx, dy, w, h);
}

function loadSample(name){
  const url = name==="gradient" ? null : name==="checker" ? null : IMG_URLS[name];
  if(name==="gradient"){
    const t=document.createElement('canvas'); t.width=t.height=256;
    const x=t.getContext('2d'); const g=x.createLinearGradient(0,0,256,256);
    g.addColorStop(0,"#000"); g.addColorStop(1,"#fff"); x.fillStyle=g; x.fillRect(0,0,256,256);
    const img = new Image(); img.src=t.toDataURL(); img.onload=()=>setSource(img);
    return;
  }
  if(name==="checker"){
    const t=document.createElement('canvas'); t.width=t.height=256;
    const x=t.getContext('2d'); const cells=16, s=256/cells;
    for(let y=0;y<cells;y++)for(let x0=0;x0<cells;x0++){
      const v=((x0+y)&1)?220:30; x.fillStyle=`rgb(${v},${v},${v})`; x.fillRect(x0*s,y*s,s,s);
    }
    const img = new Image(); img.src=t.toDataURL(); img.onload=()=>setSource(img);
    return;
  }
  const img = new Image(); img.crossOrigin="anonymous";
  img.onload = ()=> setSource(img);
  img.src = url || IMG_URLS.dogs;
}

function setSource(img){
  drawCover(img, inX, 256);
  srcImageData = inX.getImageData(0,0,256,256);
  processAndDraw();
}

// ---------- Controls wiring ----------
const controls = {
  sBright: $("#sBright"), vBright: $("#vBright"),
  sContrast: $("#sContrast"), vContrast: $("#vContrast"),
  sExposure: $("#sExposure"), vExposure: $("#vExposure"),
  sGamma: $("#sGamma"), vGamma: $("#vGamma"),
  sSat: $("#sSat"), vSat: $("#vSat"),
  sHue: $("#sHue"), vHue: $("#vHue"),
  sBlur: $("#sBlur"), vBlur: $("#vBlur"),
  sSharp: $("#sSharp"), vSharp: $("#vSharp"),
  sBits: $("#sBits"), vBits: $("#vBits"),
  tGray: $("#tGray"), tInvert: $("#tInvert"),
};

function labelUpdate(){
  controls.vBright.textContent = controls.sBright.value;
  controls.vContrast.textContent = controls.sContrast.value + "%";
  controls.vExposure.textContent = (controls.sExposure.value/100).toFixed(2) + "√ó";
  controls.vGamma.textContent = (controls.sGamma.value/100).toFixed(2);
  controls.vSat.textContent = controls.sSat.value + "%";
  controls.vHue.textContent = controls.sHue.value + "¬∞";
  controls.vBlur.textContent = controls.sBlur.value;
  controls.vSharp.textContent = (controls.sSharp.value/100).toFixed(2);
  controls.vBits.textContent = controls.sBits.value + "-bit";
}
Object.values(controls).forEach(el=>{
  if(el instanceof HTMLElement && el.tagName==="INPUT"){
    el.addEventListener('input', ()=>{ labelUpdate(); requestProcess(); });
  }
});
$("#btnReset").addEventListener('click', ()=>{
  controls.sBright.value=0; controls.sContrast.value=100; controls.sExposure.value=100;
  controls.sGamma.value=100; controls.sSat.value=100; controls.sHue.value=0;
  controls.sBlur.value=0; controls.sSharp.value=0; controls.sBits.value=8;
  controls.tGray.checked=false; controls.tInvert.checked=false;
  labelUpdate(); requestProcess();
});
$("#btnRandom").addEventListener('click', ()=>{
  const rand=(min,max)=>Math.floor(min+Math.random()*(max-min+1));
  controls.sBright.value=rand(-40,40);
  controls.sContrast.value=rand(50,180);
  controls.sExposure.value=rand(70,180);
  controls.sGamma.value=rand(60,160);
  controls.sSat.value=rand(0,220);
  controls.sHue.value=rand(-180,180);
  controls.sBlur.value=rand(0,3);
  controls.sSharp.value=rand(0,120);
  controls.sBits.value=rand(2,8);
  controls.tGray.checked=Math.random()<0.2;
  controls.tInvert.checked=Math.random()<0.2;
  labelUpdate(); requestProcess();
});
$("#imgPick").addEventListener('change', e=> loadSample(e.target.value));
$("#file").addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return;
  const img=new Image(); img.onload=()=>setSource(img);
  img.src=URL.createObjectURL(f);
});

// Drag & drop
document.addEventListener('dragover', e=>{e.preventDefault(); document.body.style.background='rgba(122,162,255,0.08)'});
document.addEventListener('dragleave', ()=>{document.body.style.background=''});
document.addEventListener('drop', e=>{
  e.preventDefault(); document.body.style.background='';
  const f=e.dataTransfer.files && e.dataTransfer.files[0]; if(!f) return;
  const img=new Image(); img.onload=()=>setSource(img); img.src=URL.createObjectURL(f);
});

// ---------- Color helpers ----------
function rgb2hsl(r,g,b){
  r/=255; g/=255; b/=255;
  const max=Math.max(r,g,b), min=Math.min(r,g,b);
  let h,s,l=(max+min)/2;
  if(max===min){ h=s=0; }
  else{
    const d=max-min;
    s=l>0.5? d/(2-max-min) : d/(max+min);
    switch(max){
      case r: h=(g-b)/d + (g<b?6:0); break;
      case g: h=(b-r)/d + 2; break;
      case b: h=(r-g)/d + 4; break;
    }
    h/=6;
  }
  return [h,s,l];
}
function hsl2rgb(h,s,l){
  function hue2rgb(p,q,t){ if(t<0)t+=1; if(t>1)t-=1;
    if(t<1/6) return p+(q-p)*6*t;
    if(t<1/2) return q;
    if(t<2/3) return p+(q-p)*(2/3 - t)*6;
    return p;
  }
  let r,g,b;
  if(s===0){ r=g=b=l; }
  else{
    const q = l<0.5 ? l*(1+s) : l+s-l*s;
    const p = 2*l - q;
    r=hue2rgb(p,q,h+1/3); g=hue2rgb(p,q,h); b=hue2rgb(p,q,h-1/3);
  }
  return [Math.round(r*255), Math.round(g*255), Math.round(b*255)];
}

// ---------- Blur (separable box blur, small radius) ----------
function blurImage(src, w, h, r){
  if(r<=0) return new Uint8ClampedArray(src); // copy
  const out=new Uint8ClampedArray(src.length);
  const tmp=new Uint8ClampedArray(src.length);
  const ch=4, win=2*r+1;
  // horizontal
  for(let y=0;y<h;y++){
    for(let c=0;c<3;c++){
      let acc=0;
      for(let dx=-r; dx<=r; dx++){
        const x0=clamp(dx,0,w-1);
        acc += src[(y*w + x0)*ch + c];
      }
      for(let x=0;x<w;x++){
        const i=(y*w + x)*ch + c;
        tmp[i] = Math.round(acc / win);
        // slide
        const xOut=x-r, xIn=x+r+1;
        const idxOut=(y*w + clamp(xOut,0,w-1))*ch + c;
        const idxIn =(y*w + clamp(xIn, 0,w-1))*ch + c;
        acc += src[idxIn] - src[idxOut];
      }
    }
    // Copy alpha channel
    for(let x=0;x<w;x++){
      tmp[(y*w + x)*ch + 3] = src[(y*w + x)*ch + 3];
    }
  }
  // vertical
  for(let x=0;x<w;x++){
    for(let c=0;c<3;c++){
      let acc=0;
      for(let dy=-r; dy<=r; dy++){
        const y0=clamp(dy,0,h-1);
        acc += tmp[(y0*w + x)*ch + c];
      }
      for(let y=0;y<h;y++){
        const i=(y*w + x)*ch + c;
        out[i] = Math.round(acc / win);
        const yOut=y-r, yIn=y+r+1;
        const idxOut=(clamp(yOut,0,h-1)*w + x)*ch + c;
        const idxIn =(clamp(yIn ,0,h-1)*w + x)*ch + c;
        acc += tmp[idxIn] - tmp[idxOut];
      }
    }
    // Copy alpha channel
    for(let y=0;y<h;y++){
      out[(y*w + x)*ch + 3] = src[(y*w + x)*ch + 3];
    }
  }
  // set alpha to 255
  for(let i=0;i<w*h;i++) out[i*4+3]=255;
  return out;
}

// ---------- Histogram ----------
function drawHistogram(imgData){
  const w=256,h=256;
  const d=imgData.data;
  const bins=new Uint32Array(256);
  for(let i=0;i<w*h;i++){
    const r=d[i*4], g=d[i*4+1], b=d[i*4+2];
    const y = Math.round(0.2126*r + 0.7152*g + 0.0722*b);
    bins[y]++;
  }
  const max = Math.max(...bins);
  histX.clearRect(0,0,histC.width,histC.height);
  for(let x=0;x<256;x++){
    const v=bins[x]/max;
    const bar = Math.max(1, Math.round(v*histC.height));
    histX.fillStyle="#7aa2ff";
    // draw from bottom
    histX.fillRect(x*(histC.width/256), histC.height - bar, Math.ceil(histC.width/256), bar);
  }
}

// ---------- Processing pipeline ----------
let rafPending = false;
function requestProcess(){
  if(rafPending) return;
  rafPending = true;
  requestAnimationFrame(()=>{ rafPending=false; processAndDraw(); });
}

function updateFormulas(){
  const bright = parseInt(controls.sBright.value);
  const contrast = parseInt(controls.sContrast.value)/100;
  const exposure = parseInt(controls.sExposure.value)/100;
  const gamma = parseInt(controls.sGamma.value)/100;
  const sat = parseInt(controls.sSat.value)/100;
  const hueDeg = parseInt(controls.sHue.value);
  const blurR = parseInt(controls.sBlur.value);
  const sharpAmt = parseInt(controls.sSharp.value)/100;
  const bits = parseInt(controls.sBits.value);
  const doGray = controls.tGray.checked;
  const doInv = controls.tInvert.checked;
  
  let formulas = [];
  
  // Always show the order of operations
  formulas.push('<span style="color:#8b93a7">Order of operations:</span>');
  
  // Hue/Saturation
  if(hueDeg !== 0 || sat !== 1){
    formulas.push('<span style="color:#ff7aa2">1. Hue/Saturation (HSL color space):</span>');
    if(hueDeg !== 0) formulas.push(`   H' = (H + ${hueDeg}¬∞) mod 360¬∞`);
    if(sat !== 1) formulas.push(`   S' = S √ó ${sat.toFixed(2)}`);
  }
  
  // Exposure
  if(exposure !== 1){
    formulas.push('<span style="color:#ff7aa2">2. Exposure:</span>');
    formulas.push(`   R' = R √ó ${exposure.toFixed(2)}`);
    formulas.push(`   G' = G √ó ${exposure.toFixed(2)}`);
    formulas.push(`   B' = B √ó ${exposure.toFixed(2)}`);
  }
  
  // Brightness/Contrast
  if(bright !== 0 || contrast !== 1){
    formulas.push('<span style="color:#ff7aa2">3. Brightness/Contrast:</span>');
    formulas.push(`   R' = (R - 128) √ó ${contrast.toFixed(2)} + 128 + ${bright}`);
    formulas.push(`   G' = (G - 128) √ó ${contrast.toFixed(2)} + 128 + ${bright}`);
    formulas.push(`   B' = (B - 128) √ó ${contrast.toFixed(2)} + 128 + ${bright}`);
  }
  
  // Gamma
  if(gamma !== 1){
    formulas.push('<span style="color:#ff7aa2">4. Gamma Correction:</span>');
    formulas.push(`   R' = 255 √ó (R/255)^(1/${gamma.toFixed(2)})`);
    formulas.push(`   G' = 255 √ó (G/255)^(1/${gamma.toFixed(2)})`);
    formulas.push(`   B' = 255 √ó (B/255)^(1/${gamma.toFixed(2)})`);
  }
  
  // Blur
  if(blurR > 0){
    formulas.push('<span style="color:#ff7aa2">5. Box Blur:</span>');
    formulas.push(`   kernel size = ${2*blurR+1}√ó${2*blurR+1}`);
    formulas.push(`   pixel' = Œ£(neighbors) / ${(2*blurR+1)*(2*blurR+1)}`);
  }
  
  // Sharpening
  if(sharpAmt > 0){
    formulas.push('<span style="color:#ff7aa2">6. Unsharp Mask:</span>');
    formulas.push(`   pixel' = blurred + ${sharpAmt.toFixed(2)} √ó (original - blurred)`);
  }
  
  // Bit depth
  if(bits < 8){
    formulas.push('<span style="color:#ff7aa2">7. Bit Depth Quantization:</span>');
    const levels = (1<<bits)-1;
    formulas.push(`   levels = ${levels + 1} (${bits}-bit)`);
    formulas.push(`   pixel' = round(pixel √ó ${levels}/255) √ó 255/${levels}`);
  }
  
  // Grayscale
  if(doGray){
    formulas.push('<span style="color:#ff7aa2">8. Grayscale (ITU-R BT.709):</span>');
    formulas.push(`   Y = 0.2126√óR + 0.7152√óG + 0.0722√óB`);
    formulas.push(`   R' = G' = B' = Y`);
  }
  
  // Invert
  if(doInv){
    formulas.push('<span style="color:#ff7aa2">9. Invert:</span>');
    formulas.push(`   R' = 255 - R`);
    formulas.push(`   G' = 255 - G`);
    formulas.push(`   B' = 255 - B`);
  }
  
  // If no operations active
  if(formulas.length === 1){
    formulas.push('<span style="color:#8b93a7">No transformations active - showing original image</span>');
  }
  
  // Add note about clamping
  formulas.push('');
  formulas.push('<span style="color:#8b93a7;font-size:11px">Note: All values are clamped to [0, 255] range</span>');
  
  $("#formulasDisplay").innerHTML = formulas.join('<br>');
}

function processAndDraw(){
  if(!srcImageData) return;
  
  // Update formulas display
  updateFormulas();
  
  const w=256,h=256;
  const src = srcImageData.data;
  const out = new Uint8ClampedArray(src.length);

  // Read controls
  const bright = parseInt(controls.sBright.value);               // [-100..100]
  const contrast = parseInt(controls.sContrast.value)/100;       // [0..3]
  const exposure = parseInt(controls.sExposure.value)/100;       // [0.1..3]
  const gamma = Math.max(0.2, parseInt(controls.sGamma.value)/100); // [0.2..3]
  const sat = parseInt(controls.sSat.value)/100;                 // [0..3]
  const hueDeg = parseInt(controls.sHue.value);                  // [-180..180]
  const hue = ((hueDeg%360)+360)%360/360;                        // 0..1 cyc
  const blurR = parseInt(controls.sBlur.value);                  // 0..5
  const sharpAmt = parseInt(controls.sSharp.value)/100;          // 0..2
  const bits = parseInt(controls.sBits.value);                   // 1..8
  const doGray = controls.tGray.checked;
  const doInv = controls.tInvert.checked;

  // First pass: H/S adjustment + exposure, brightness/contrast, gamma
  // Apply in linear-ish order
  for(let i=0;i<w*h;i++){
    let r=src[i*4], g=src[i*4+1], b=src[i*4+2];

    // Hue/Sat in HSL
    let [H,S,L] = rgb2hsl(r,g,b);
    H = (H + hue) % 1;
    S = clamp(Math.round(S*sat*255),0,255)/255;
    ;[r,g,b] = hsl2rgb(H,S,L);

    // Exposure (scale)
    r = clamp(r*exposure); g = clamp(g*exposure); b = clamp(b*exposure);

    // Contrast / Brightness (pivot at 128)
    r = clamp((r-128)*contrast + 128 + bright);
    g = clamp((g-128)*contrast + 128 + bright);
    b = clamp((b-128)*contrast + 128 + bright);

    // Gamma (apply per-channel, normalize 0..1 then pow(1/gamma))
    r = clamp(Math.pow(r/255, 1/gamma)*255);
    g = clamp(Math.pow(g/255, 1/gamma)*255);
    b = clamp(Math.pow(b/255, 1/gamma)*255);

    out[i*4]=r; out[i*4+1]=g; out[i*4+2]=b; out[i*4+3]=255;
  }

  // Blur (separable box)
  const blurred = blurImage(out, w, h, blurR);

  // Unsharp mask: out = blurred + amount*(original - blurred)
  if(sharpAmt>0){
    for(let i=0;i<w*h;i++){
      for(let c=0;c<3;c++){
        const o = out[i*4+c];
        const bl = blurred[i*4+c];
        const val = clamp(bl + sharpAmt*(o - bl));
        out[i*4+c]=val;
      }
    }
  } else {
    // replace with blurred if blur > 0
    if(blurR>0) out.set(blurred);
  }

  // Bit depth quantization (per channel)
  const levels = (1<<bits)-1; // e.g., 255 for 8-bit
  for(let i=0;i<w*h;i++){
    for(let c=0;c<3;c++){
      let v = out[i*4+c]/255;
      v = Math.round(v*levels)/levels;
      out[i*4+c] = clamp(Math.round(v*255));
    }
  }

  // Grayscale / Invert toggles at the end
  if(doGray || doInv){
    for(let i=0;i<w*h;i++){
      let r=out[i*4], g=out[i*4+1], b=out[i*4+2];
      if(doGray){
        const y=Math.round(0.2126*r + 0.7152*g + 0.0722*b);
        r=g=b=y;
      }
      if(doInv){
        r=255-r; g=255-g; b=255-b;
      }
      out[i*4]=r; out[i*4+1]=g; out[i*4+2]=b;
    }
  }

  // Draw
  const outImg = new ImageData(out, w, h);
  outX.putImageData(outImg,0,0);

  // Stats + histogram
  computeStatsAndHistogram(outImg);
}

function computeStatsAndHistogram(img){
  const d=img.data, n=256*256;
  let min=255, max=0, sum=0, sum2=0;
  for(let i=0;i<n;i++){
    const y = Math.round(0.2126*d[i*4] + 0.7152*d[i*4+1] + 0.0722*d[i*4+2]);
    min=Math.min(min,y); max=Math.max(max,y);
    sum += y; sum2 += y*y;
  }
  const mean = sum/n;
  const variance = sum2/n - mean*mean;
  const std = Math.sqrt(Math.max(0,variance));
  $("#stMean").textContent = mean.toFixed(1);
  $("#stStd").textContent = std.toFixed(1);
  $("#stMinMax").textContent = `${min}‚Ä¶${max}`;
  drawHistogram(img);
}

// ---------- Init ----------
function init(){
  labelUpdate();
  loadSample("dogs");
}
init();
</script>
</body>
</html>
